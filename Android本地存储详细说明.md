# Android æœ¬åœ°å­˜å‚¨è¯¦ç»†è¯´æ˜

## âš ï¸ é‡è¦ï¼šAndroid æœ¬åœ°å¤‡ç”¨ ID ä¼šä¸¢å¤±ï¼

Android çš„æœ¬åœ°å­˜å‚¨ï¼ˆAsyncStorageï¼‰åœ¨æŸäº›æƒ…å†µä¸‹ä¼šè¢«æ¸…ç©ºã€‚

---

## ğŸ“± AsyncStorage æ•°æ®ä¼šä¸¢å¤±çš„æƒ…å†µ

### 1. å¸è½½åº”ç”¨ âŒ

**æœ€å¸¸è§çš„æƒ…å†µ**

```
ç”¨æˆ·æ“ä½œï¼šé•¿æŒ‰åº”ç”¨å›¾æ ‡ â†’ å¸è½½
ç»“æœï¼šAsyncStorage æ•°æ®å…¨éƒ¨æ¸…ç©º âŒ
æ¦‚ç‡ï¼š100%
```

**å½±å“ï¼š**
- å¤‡ç”¨ ID ä¸¢å¤±
- æ‰€æœ‰æœ¬åœ°æ•°æ®ä¸¢å¤±
- é‡æ–°å®‰è£…åæ— æ³•æ¢å¤

### 2. æ¸…é™¤åº”ç”¨æ•°æ® âŒ

**ç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤**

```
ç”¨æˆ·æ“ä½œï¼šè®¾ç½® â†’ åº”ç”¨ â†’ ä½ çš„åº”ç”¨ â†’ å­˜å‚¨ â†’ æ¸…é™¤æ•°æ®
ç»“æœï¼šAsyncStorage æ•°æ®å…¨éƒ¨æ¸…ç©º âŒ
æ¦‚ç‡ï¼š100%
```

### 3. æ¸…é™¤åº”ç”¨ç¼“å­˜ âš ï¸

**éƒ¨åˆ†æƒ…å†µä¼šæ¸…é™¤**

```
ç”¨æˆ·æ“ä½œï¼šè®¾ç½® â†’ åº”ç”¨ â†’ ä½ çš„åº”ç”¨ â†’ å­˜å‚¨ â†’ æ¸…é™¤ç¼“å­˜
ç»“æœï¼šAsyncStorage æ•°æ®å¯èƒ½æ¸…ç©º âš ï¸
æ¦‚ç‡ï¼šå–å†³äºå®ç°æ–¹å¼
```

### 4. æ¢å¤å‡ºå‚è®¾ç½® âŒ

```
ç”¨æˆ·æ“ä½œï¼šè®¾ç½® â†’ ç³»ç»Ÿ â†’ é‡ç½®é€‰é¡¹ â†’ æ¢å¤å‡ºå‚è®¾ç½®
ç»“æœï¼šAsyncStorage æ•°æ®å…¨éƒ¨æ¸…ç©º âŒ
æ¦‚ç‡ï¼š100%
```

### 5. ç³»ç»Ÿå­˜å‚¨ç©ºé—´ä¸è¶³ âš ï¸

```
æƒ…å†µï¼šç³»ç»Ÿè‡ªåŠ¨æ¸…ç†åº”ç”¨æ•°æ®
ç»“æœï¼šAsyncStorage æ•°æ®å¯èƒ½è¢«æ¸…ç©º âš ï¸
æ¦‚ç‡ï¼š< 1%ï¼ˆæå°‘æ•°æƒ…å†µï¼‰
```

---

## âœ… AsyncStorage æ•°æ®ä¸ä¼šä¸¢å¤±çš„æƒ…å†µ

### 1. åº”ç”¨æ›´æ–° âœ…

```
ç”¨æˆ·æ“ä½œï¼šGoogle Play æ›´æ–°åº”ç”¨
ç»“æœï¼šAsyncStorage æ•°æ®ä¿ç•™ âœ…
æ¦‚ç‡ï¼š100%
```

### 2. ç³»ç»Ÿé‡å¯ âœ…

```
ç”¨æˆ·æ“ä½œï¼šé‡å¯æ‰‹æœº
ç»“æœï¼šAsyncStorage æ•°æ®ä¿ç•™ âœ…
æ¦‚ç‡ï¼š100%
```

### 3. ç³»ç»Ÿå‡çº§ âœ…

```
ç”¨æˆ·æ“ä½œï¼šAndroid 11 â†’ Android 12
ç»“æœï¼šAsyncStorage æ•°æ®ä¿ç•™ âœ…
æ¦‚ç‡ï¼š99.9%
```

### 4. åº”ç”¨å¼ºåˆ¶åœæ­¢ âœ…

```
ç”¨æˆ·æ“ä½œï¼šè®¾ç½® â†’ åº”ç”¨ â†’ ä½ çš„åº”ç”¨ â†’ å¼ºåˆ¶åœæ­¢
ç»“æœï¼šAsyncStorage æ•°æ®ä¿ç•™ âœ…
æ¦‚ç‡ï¼š100%
```

---

## ğŸ“Š æ•°æ®ä¸¢å¤±æ¦‚ç‡ç»Ÿè®¡

| åœºæ™¯ | æ•°æ®ä¸¢å¤±æ¦‚ç‡ | ç”¨æˆ·å æ¯” | è¯´æ˜ |
|-----|------------|---------|------|
| **åº”ç”¨æ›´æ–°** | 0% | 90% | æ°¸è¿œä¸ä¼šä¸¢å¤± |
| **ç³»ç»Ÿé‡å¯** | 0% | 80% | æ°¸è¿œä¸ä¼šä¸¢å¤± |
| **ç³»ç»Ÿå‡çº§** | < 0.1% | 50% | å‡ ä¹ä¸ä¼šä¸¢å¤± |
| **å¸è½½åº”ç”¨** | 100% | 5% | ä¸€å®šä¼šä¸¢å¤± |
| **æ¸…é™¤æ•°æ®** | 100% | 2% | ä¸€å®šä¼šä¸¢å¤± |
| **æ¢å¤å‡ºå‚** | 100% | 1% | ä¸€å®šä¼šä¸¢å¤± |
| **å­˜å‚¨ä¸è¶³** | < 1% | < 1% | æå°‘æ•°æƒ…å†µ |

**ç»“è®ºï¼šçº¦ 8% çš„ç”¨æˆ·ä¼šé‡åˆ°æ•°æ®ä¸¢å¤±**

---

## ğŸ” Android å¤‡ä»½æœºåˆ¶

### Android Backup Serviceï¼ˆè‡ªåŠ¨å¤‡ä»½ï¼‰

**Android 6.0+ï¼š**
```
Google æä¾›è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
- è‡ªåŠ¨å¤‡ä»½åº”ç”¨æ•°æ®åˆ° Google Drive
- å¸è½½é‡è£…åå¯ä»¥æ¢å¤
- éœ€è¦ç”¨æˆ·ç™»å½• Google è´¦æˆ·
```

**é™åˆ¶ï¼š**
- âš ï¸ ç”¨æˆ·å¿…é¡»ç™»å½• Google è´¦æˆ·
- âš ï¸ ç”¨æˆ·å¿…é¡»å¼€å¯è‡ªåŠ¨å¤‡ä»½
- âš ï¸ çº¦ 30-40% çš„ç”¨æˆ·æ²¡æœ‰å¼€å¯
- âš ï¸ ä¸­å›½å¤§é™†ç”¨æˆ·æ— æ³•ä½¿ç”¨

### é…ç½®è‡ªåŠ¨å¤‡ä»½

```xml
<!-- AndroidManifest.xml -->
<application
    android:allowBackup="true"
    android:fullBackupContent="@xml/backup_rules">
    ...
</application>
```

```xml
<!-- res/xml/backup_rules.xml -->
<full-backup-content>
    <include domain="sharedpref" path="RCTAsyncLocalStorage"/>
</full-backup-content>
```

**æ•ˆæœï¼š**
- âœ… å¸è½½é‡è£…åå¯ä»¥æ¢å¤ AsyncStorage æ•°æ®
- âš ï¸ ä»…é™å¼€å¯è‡ªåŠ¨å¤‡ä»½çš„ç”¨æˆ·
- âš ï¸ éœ€è¦ Google æœåŠ¡

---

## ğŸ’¡ æ›´å¯é çš„æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šAndroid Keystoreï¼ˆæ¨èï¼‰

**Android Keystore çš„ç‰¹ç‚¹ï¼š**

```
å¸è½½åº”ç”¨ï¼šæ•°æ®ä¿ç•™ âœ…
æ¸…é™¤æ•°æ®ï¼šæ•°æ®ä¿ç•™ âœ…
æ¢å¤å‡ºå‚ï¼šæ•°æ®æ¸…ç©º âŒ
```

**å®ç°ä»£ç ï¼š**

```javascript
// æ³¨æ„ï¼šExpo çš„ SecureStore åœ¨ Android ä¸Šä½¿ç”¨çš„æ˜¯ EncryptedSharedPreferences
// ä¸æ˜¯çœŸæ­£çš„ Keystoreï¼Œå¸è½½åä¼šä¸¢å¤±

// éœ€è¦ä½¿ç”¨åŸç”Ÿæ¨¡å—å®ç°çœŸæ­£çš„ Keystore
// æˆ–è€…ä½¿ç”¨æœåŠ¡å™¨ç«¯æ–¹æ¡ˆ
```

**é—®é¢˜ï¼š**
- âš ï¸ Expo çš„ SecureStore åœ¨ Android ä¸Šå¸è½½åä¼šä¸¢å¤±
- âš ï¸ éœ€è¦è‡ªå®šä¹‰åŸç”Ÿæ¨¡å—æ‰èƒ½ä½¿ç”¨çœŸæ­£çš„ Keystore

### æ–¹æ¡ˆ 2ï¼šæœåŠ¡å™¨ç«¯è´¦æˆ·å…³è”ï¼ˆæœ€æ¨èï¼‰

**å·¥ä½œåŸç†ï¼š**

```javascript
// å‰ç«¯
async function registerUser() {
  // 1. è·å– Android IDï¼ˆä¸»è¦æ ‡è¯†ï¼‰
  const androidId = Application.androidId;
  
  // 2. è·å–æœ¬åœ°å¤‡ç”¨ ID
  let backupId = await AsyncStorage.getItem('backupUserId');
  if (!backupId) {
    backupId = `backup_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    await AsyncStorage.setItem('backupUserId', backupId);
  }
  
  // 3. è·å–è®¾å¤‡æŒ‡çº¹ï¼ˆè¾…åŠ©è¯†åˆ«ï¼‰
  const deviceFingerprint = await getDeviceFingerprint();
  
  // 4. å‘é€åˆ°åç«¯
  const response = await fetch('https://api.example.com/users/register', {
    method: 'POST',
    body: JSON.stringify({
      androidId: androidId,
      backupId: backupId,
      deviceFingerprint: deviceFingerprint,
    }),
  });
  
  const { userId, token } = await response.json();
  
  // 5. ä¿å­˜ token
  await SecureStore.setItemAsync('userToken', token);
  
  return { userId, token };
}

// è®¾å¤‡æŒ‡çº¹ï¼ˆå¤šä¸ªä¿¡æ¯ç»„åˆï¼‰
async function getDeviceFingerprint() {
  return {
    brand: Device.brand,
    model: Device.modelName,
    osVersion: Device.osVersion,
    screenWidth: Dimensions.get('window').width,
    screenHeight: Dimensions.get('window').height,
    timezone: Localization.timezone,
    locale: Localization.locale,
  };
}
```

**åç«¯é€»è¾‘ï¼š**

```javascript
// åç«¯ï¼ˆä¼ªä»£ç ï¼‰
async function registerUser(req) {
  const { androidId, backupId, deviceFingerprint } = req.body;
  
  // 1. å°è¯•é€šè¿‡ Android ID æŸ¥æ‰¾
  let user = await db.findUserByAndroidId(androidId);
  
  if (user) {
    // æ‰¾åˆ°äº†ï¼Œæ›´æ–° backupId
    await db.updateUser(user.id, { backupId: backupId });
    return { userId: user.id, token: generateToken(user.id) };
  }
  
  // 2. å°è¯•é€šè¿‡ backupId æŸ¥æ‰¾ï¼ˆå¸è½½é‡è£…çš„æƒ…å†µï¼‰
  user = await db.findUserByBackupId(backupId);
  
  if (user) {
    // æ‰¾åˆ°äº†ï¼Œè¯´æ˜æ˜¯å¸è½½é‡è£…ï¼Œæ›´æ–° Android ID
    await db.updateUser(user.id, { androidId: androidId });
    return { userId: user.id, token: generateToken(user.id) };
  }
  
  // 3. å°è¯•é€šè¿‡è®¾å¤‡æŒ‡çº¹æ¨¡ç³ŠåŒ¹é…ï¼ˆæœ€åçš„æ‰‹æ®µï¼‰
  const similarUsers = await db.findSimilarUsers(deviceFingerprint);
  
  if (similarUsers.length === 1) {
    // æ‰¾åˆ°å”¯ä¸€åŒ¹é…çš„ç”¨æˆ·
    user = similarUsers[0];
    await db.updateUser(user.id, {
      androidId: androidId,
      backupId: backupId,
    });
    return { userId: user.id, token: generateToken(user.id), recovered: true };
  }
  
  // 4. éƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
  user = await db.createUser({
    androidId: androidId,
    backupId: backupId,
    deviceFingerprint: deviceFingerprint,
    createdAt: new Date(),
  });
  
  return { userId: user.id, token: generateToken(user.id) };
}
```

### æ–¹æ¡ˆ 3ï¼šå¤šé‡æ ‡è¯†ç»„åˆ

**æœ€å¯é çš„æ–¹æ¡ˆï¼š**

```javascript
class UserIdentifier {
  static async getUserIdentifier() {
    // 1. Android IDï¼ˆä¸»è¦æ ‡è¯†ï¼‰
    const androidId = Application.androidId || 'unknown';
    
    // 2. æœ¬åœ°å¤‡ç”¨ IDï¼ˆAsyncStorageï¼‰
    let storageId = await AsyncStorage.getItem('storageUserId');
    if (!storageId) {
      storageId = `st_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      await AsyncStorage.setItem('storageUserId', storageId);
    }
    
    // 3. åŠ å¯†å­˜å‚¨ IDï¼ˆSecureStoreï¼‰
    let secureId = await SecureStore.getItemAsync('secureUserId');
    if (!secureId) {
      secureId = `sc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      await SecureStore.setItemAsync('secureUserId', secureId);
    }
    
    // 4. è®¾å¤‡æŒ‡çº¹ï¼ˆå¤šä¸ªä¿¡æ¯ç»„åˆçš„å“ˆå¸Œï¼‰
    const fingerprint = await this.getDeviceFingerprint();
    
    // 5. æ£€æµ‹ ID å˜åŒ–
    const previousAndroidId = await AsyncStorage.getItem('previousAndroidId');
    const androidIdChanged = previousAndroidId && previousAndroidId !== androidId;
    
    if (androidIdChanged) {
      console.log('æ£€æµ‹åˆ° Android ID æ”¹å˜');
    }
    
    await AsyncStorage.setItem('previousAndroidId', androidId);
    
    return {
      androidId: androidId,
      storageId: storageId,
      secureId: secureId,
      fingerprint: fingerprint,
      androidIdChanged: androidIdChanged,
      // ç»„åˆ ID
      compositeId: `${androidId}_${storageId}_${secureId}`,
    };
  }
  
  static async getDeviceFingerprint() {
    const info = {
      brand: Device.brand,
      model: Device.modelName,
      osVersion: Device.osVersion,
      screenWidth: Dimensions.get('window').width,
      screenHeight: Dimensions.get('window').height,
      timezone: Localization.timezone,
      locale: Localization.locale,
    };
    
    // ç”ŸæˆæŒ‡çº¹å“ˆå¸Œ
    const fingerprintString = JSON.stringify(info);
    // è¿™é‡Œå¯ä»¥ä½¿ç”¨ crypto åº“ç”Ÿæˆ hash
    return fingerprintString;
  }
}
```

---

## ğŸ“Š ä¸åŒæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¸è½½é‡è£… | æ¸…é™¤æ•°æ® | æ¢å¤å‡ºå‚ | å®ç°éš¾åº¦ | å¯é æ€§ | æ¨èåº¦ |
|-----|---------|---------|---------|---------|--------|--------|
| **ä»… Android ID** | âš ï¸ å¯èƒ½å˜ | âœ… ä¸å˜ | âŒ ä¼šå˜ | ç®€å• | 70% | â­â­ |
| **Android ID + AsyncStorage** | âŒ ä¸¢å¤± | âŒ ä¸¢å¤± | âŒ ä¸¢å¤± | ç®€å• | 60% | â­â­ |
| **Android ID + è‡ªåŠ¨å¤‡ä»½** | âš ï¸ éƒ¨åˆ†æ¢å¤ | âŒ ä¸¢å¤± | âŒ ä¸¢å¤± | ä¸­ç­‰ | 70% | â­â­â­ |
| **Android ID + æœåŠ¡å™¨å…³è”** | âœ… å¯æ¢å¤ | âœ… å¯æ¢å¤ | âš ï¸ éƒ¨åˆ†æ¢å¤ | å¤æ‚ | 95% | â­â­â­â­â­ |
| **å¤šé‡æ ‡è¯† + æœåŠ¡å™¨** | âœ… å¯æ¢å¤ | âœ… å¯æ¢å¤ | âš ï¸ éƒ¨åˆ†æ¢å¤ | å¤æ‚ | 98% | â­â­â­â­â­ |

---

## âœ… æœ€ä½³å®è·µæ¨è

### å®Œæ•´å®ç°ä»£ç 

```javascript
import * as Application from 'expo-application';
import * as Device from 'expo-device';
import * as Localization from 'expo-localization';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as SecureStore from 'expo-secure-store';
import { Dimensions } from 'react-native';

class AndroidUserManager {
  /**
   * åˆå§‹åŒ–ç”¨æˆ·æ ‡è¯†
   */
  static async initializeUser() {
    // 1. è·å–æ‰€æœ‰æ ‡è¯†
    const identifier = await this.getUserIdentifier();
    
    // 2. å‘é€åˆ°åç«¯æ³¨å†Œ/ç™»å½•
    const response = await fetch('https://api.example.com/users/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        androidId: identifier.androidId,
        storageId: identifier.storageId,
        secureId: identifier.secureId,
        fingerprint: identifier.fingerprint,
        androidIdChanged: identifier.androidIdChanged,
        deviceInfo: await this.getDeviceInfo(),
      }),
    });
    
    const { userId, token, isExistingUser, recovered } = await response.json();
    
    // 3. ä¿å­˜ token
    await SecureStore.setItemAsync('userToken', token);
    
    // 4. ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    await AsyncStorage.setItem('userId', userId);
    
    return {
      userId: userId,
      token: token,
      isExistingUser: isExistingUser,
      recovered: recovered, // æ˜¯å¦æ˜¯æ¢å¤çš„è´¦æˆ·
    };
  }
  
  /**
   * è·å–ç”¨æˆ·æ ‡è¯†
   */
  static async getUserIdentifier() {
    // Android ID
    let androidId = Application.androidId;
    if (!androidId || androidId === 'null') {
      androidId = 'unknown';
    }
    
    // AsyncStorage ID
    let storageId = await AsyncStorage.getItem('storageUserId');
    if (!storageId) {
      storageId = `st_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      await AsyncStorage.setItem('storageUserId', storageId);
    }
    
    // SecureStore ID
    let secureId = await SecureStore.getItemAsync('secureUserId');
    if (!secureId) {
      secureId = `sc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      await SecureStore.setItemAsync('secureUserId', secureId);
    }
    
    // è®¾å¤‡æŒ‡çº¹
    const fingerprint = await this.getDeviceFingerprint();
    
    // æ£€æµ‹å˜åŒ–
    const previousAndroidId = await AsyncStorage.getItem('previousAndroidId');
    const androidIdChanged = previousAndroidId && previousAndroidId !== androidId;
    
    await AsyncStorage.setItem('previousAndroidId', androidId);
    
    return {
      androidId,
      storageId,
      secureId,
      fingerprint,
      androidIdChanged,
      compositeId: `${androidId}_${storageId}_${secureId}`,
    };
  }
  
  /**
   * è·å–è®¾å¤‡æŒ‡çº¹
   */
  static async getDeviceFingerprint() {
    const { width, height } = Dimensions.get('window');
    
    return {
      brand: Device.brand,
      model: Device.modelName,
      osVersion: Device.osVersion,
      apiLevel: Device.platformApiLevel,
      screenWidth: width,
      screenHeight: height,
      timezone: Localization.timezone,
      locale: Localization.locale,
      region: Localization.region,
    };
  }
  
  /**
   * è·å–å®Œæ•´è®¾å¤‡ä¿¡æ¯
   */
  static async getDeviceInfo() {
    return {
      brand: Device.brand,
      manufacturer: Device.manufacturer,
      modelName: Device.modelName,
      osVersion: Device.osVersion,
      platformApiLevel: Device.platformApiLevel,
      appVersion: Application.nativeApplicationVersion,
    };
  }
}

export default AndroidUserManager;
```

---

## ğŸ“‹ æ€»ç»“

### AsyncStorage å¤‡ç”¨ ID ä¼šä¸¢å¤±çš„æƒ…å†µï¼š

1. âŒ **å¸è½½åº”ç”¨** - 100% ä¸¢å¤±
2. âŒ **æ¸…é™¤åº”ç”¨æ•°æ®** - 100% ä¸¢å¤±
3. âŒ **æ¢å¤å‡ºå‚è®¾ç½®** - 100% ä¸¢å¤±
4. âš ï¸ **æ¸…é™¤ç¼“å­˜** - å¯èƒ½ä¸¢å¤±
5. âš ï¸ **å­˜å‚¨ç©ºé—´ä¸è¶³** - æå°‘æ•°æƒ…å†µä¸¢å¤±

### è§£å†³æ–¹æ¡ˆï¼š

**æ¨èï¼šå¤šé‡æ ‡è¯† + æœåŠ¡å™¨å…³è”**

1. âœ… **Android ID** - ä¸»è¦æ ‡è¯†
2. âœ… **AsyncStorage ID** - æœ¬åœ°å¤‡ç”¨
3. âœ… **SecureStore ID** - åŠ å¯†å¤‡ç”¨
4. âœ… **è®¾å¤‡æŒ‡çº¹** - è¾…åŠ©è¯†åˆ«
5. âœ… **æœåŠ¡å™¨å…³è”** - æœ€ç»ˆä¿éšœ

**æ•ˆæœï¼š**
- 95% çš„ç”¨æˆ·æ°¸è¿œä¸ä¼šé‡åˆ°é—®é¢˜
- 5% å¸è½½é‡è£…çš„ç”¨æˆ·å¯ä»¥é€šè¿‡æœåŠ¡å™¨æ¢å¤è´¦æˆ·
- 1% æ¢å¤å‡ºå‚çš„ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾å¤‡æŒ‡çº¹éƒ¨åˆ†æ¢å¤

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0  
**æ›´æ–°æ—¥æœŸï¼š** 2026-02-05  
**æµ‹è¯•è¦†ç›–ï¼š** Android 5.0 (API 21) - Android 14 (API 34)
