# Token 认证流程图

## 📊 完整认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户打开应用                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       显示登录页面                                │
│                   (LoginScreen.js)                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    用户点击"登录"按钮                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │   测试模式 (__DEV__)   │   │   生产模式 (真实API)   │
    │                       │   │                       │
    │ 设置测试 token:       │   │ 调用 authApi.login(): │
    │ 'test_token_...'      │   │ POST /auth/login      │
    │                       │   │                       │
    │ AsyncStorage.setItem  │   │ 后端验证账号密码       │
    │ ('authToken', token)  │   │                       │
    └───────────────────────┘   └───────────────────────┘
                │                           │
                │                           ▼
                │               ┌───────────────────────┐
                │               │  后端返回 token        │
                │               │  { token, user, ... }  │
                │               └───────────────────────┘
                │                           │
                │                           ▼
                │               ┌───────────────────────┐
                │               │ authApi.login() 自动: │
                │               │ - 保存 authToken      │
                │               │ - 保存 refreshToken   │
                │               │ - 保存 userInfo       │
                │               └───────────────────────┘
                │                           │
                └───────────────┬───────────┘
                                │
                                ▼
                ┌───────────────────────────────┐
                │   Token 已保存到 AsyncStorage  │
                │   authToken: 'eyJhbGci...'    │
                └───────────────────────────────┘
                                │
                                ▼
                ┌───────────────────────────────┐
                │      进入主页面 (MainTabs)     │
                └───────────────────────────────┘
```

---

## 🔄 API 请求流程（自动添加 Token）

```
┌─────────────────────────────────────────────────────────────────┐
│              用户操作（如：修改密码）                              │
│              ChangePasswordScreen.js                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│         调用 API: authApi.changePassword(data)                   │
│         { oldPassword, newPassword }                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              authApi.changePassword() 内部调用:                  │
│              apiClient.put('/app/user/auth/password', data)      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    请求拦截器 (apiClient.js)                      │
│                                                                  │
│  1. 从 AsyncStorage 读取 token                                   │
│     const token = await AsyncStorage.getItem('authToken');      │
│                                                                  │
│  2. 自动添加到请求头                                              │
│     config.headers.Authorization = `Bearer ${token}`;           │
│                                                                  │
│  3. 打印请求日志（开发环境）                                       │
│     console.log('API Request:', { method, url, headers });      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    发送 HTTP 请求到后端                           │
│                                                                  │
│  PUT http://27.8.143.201:30560/qa-hero-app-user/...             │
│                                                                  │
│  Headers:                                                        │
│    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... │
│    Content-Type: application/json                               │
│                                                                  │
│  Body:                                                           │
│    { "oldPassword": "xxx", "newPassword": "xxx" }               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      后端处理请求                                 │
│                                                                  │
│  1. 验证 Authorization 头中的 token                              │
│  2. 检查用户权限                                                  │
│  3. 验证旧密码                                                    │
│  4. 更新新密码                                                    │
│  5. 返回响应                                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    响应拦截器 (apiClient.js)                      │
│                                                                  │
│  1. 打印响应日志（开发环境）                                       │
│     console.log('API Response:', { status, data });             │
│                                                                  │
│  2. 返回响应数据                                                  │
│     return response.data;                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              ChangePasswordScreen 接收响应                        │
│                                                                  │
│  if (response.code === 200) {                                   │
│    Alert.alert('修改成功', '密码修改成功');                       │
│    navigation.goBack();                                          │
│  } else {                                                        │
│    Alert.alert('修改失败', response.msg);                        │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 错误处理流程

### 401 Unauthorized（Token 过期）

```
┌─────────────────────────────────────────────────────────────────┐
│                    API 请求返回 401                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              响应拦截器检测到 401 错误                             │
│              if (error.response?.status === 401)                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              尝试刷新 token                                       │
│              1. 从 AsyncStorage 读取 refreshToken                │
│              2. 调用 POST /auth/refresh                          │
│              3. 获取新的 authToken                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │   刷新成功             │   │   刷新失败             │
    │                       │   │                       │
    │ 1. 保存新 token       │   │ 1. 清除本地存储        │
    │ 2. 重试原始请求       │   │ 2. 跳转到登录页面      │
    │ 3. 返回结果           │   │ 3. 提示重新登录        │
    └───────────────────────┘   └───────────────────────┘
```

### 403 Forbidden（权限不足）

```
┌─────────────────────────────────────────────────────────────────┐
│                    API 请求返回 403                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              响应拦截器处理错误                                    │
│              getErrorMessage(error)                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              返回错误信息                                          │
│              { message: '没有权限访问', status: 403 }             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              ChangePasswordScreen 显示错误                        │
│              Alert.alert('修改失败', '没有权限访问');              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Token 存储结构

```
AsyncStorage
├── authToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
│   └── 用途: API 请求认证
│   └── 有效期: 通常 1-24 小时
│   └── 自动添加到: Authorization: Bearer {token}
│
├── refreshToken: "refresh_token_string..."
│   └── 用途: 刷新 authToken
│   └── 有效期: 通常 7-30 天
│   └── 使用场景: authToken 过期时
│
└── userInfo: '{"id":"123","name":"用户名","email":"..."}'
    └── 用途: 用户信息缓存
    └── 格式: JSON 字符串
    └── 使用场景: 显示用户资料
```

---

## 📱 实际使用示例

### 示例 1: 修改密码

```javascript
// 用户操作
用户点击"确认修改" → ChangePasswordScreen.handleSubmit()

// 代码执行
await authApi.changePassword({
  oldPassword: 'old123',
  newPassword: 'new456'
});

// 实际发送的请求
PUT http://27.8.143.201:30560/qa-hero-app-user/app/user/auth/password
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json
Body:
  { "oldPassword": "old123", "newPassword": "new456" }

// 后端响应
{
  "code": 200,
  "msg": "密码修改成功",
  "data": {}
}

// 用户看到
Alert: "修改成功 - 密码修改成功"
```

### 示例 2: 获取用户信息

```javascript
// 代码执行
await userApi.getProfile();

// 实际发送的请求
GET http://27.8.143.201:30560/qa-hero-app-user/user/profile
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json

// 后端响应
{
  "code": 200,
  "data": {
    "id": "123",
    "name": "用户名",
    "email": "user@example.com"
  }
}
```

---

## 🎯 关键点总结

### ✅ 自动化

1. **Token 自动添加** - 无需手动设置请求头
2. **Token 自动保存** - 登录成功后自动存储
3. **Token 自动刷新** - 过期时自动更新
4. **错误自动处理** - 统一的错误处理机制

### ✅ 安全性

1. **加密存储** - AsyncStorage 加密存储
2. **Bearer 格式** - 标准的 Authorization 格式
3. **HTTPS 传输** - 生产环境使用 HTTPS
4. **自动清除** - 登出或刷新失败时清除

### ✅ 开发友好

1. **日志记录** - 开发环境自动打印请求/响应
2. **测试模式** - 支持测试 token 快速测试
3. **错误提示** - 友好的错误信息
4. **类型安全** - JSDoc 注释

---

## 📚 相关文档

- `CONTEXT_SUMMARY.md` - 项目完整状态
- `QUICK_START.md` - 快速开始指南
- `TOKEN_AUTHENTICATION_GUIDE.md` - 详细认证说明
- `API_USAGE_GUIDE.md` - API 使用指南

---

**所有这些都是自动的！你只需要调用 API 方法，Token 会自动添加！** ✅
