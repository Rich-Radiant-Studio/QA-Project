import React, { useState, useEffect } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { StatusBar } from 'expo-status-bar';
import { View, Text, Modal, TouchableOpacity, TextInput, StyleSheet, ScrollView, SafeAreaView, Platform, ActivityIndicator } from 'react-native';
import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as Font from 'expo-font';
import i18n from './src/i18n';
import superLikeCreditService from './src/services/SuperLikeCreditService';
import DeviceInfo from './src/utils/deviceInfo';
import authApi from './src/services/api/authApi';
import DebugToken from './src/utils/debugToken';
import UserCacheService from './src/services/UserCacheService';
import ToastContainer from './src/components/ToastContainer';
import { setToastRef, showToast } from './src/utils/toast';

import HomeScreen from './src/screens/HomeScreen';
import SearchScreen from './src/screens/SearchScreen';
import PublishScreen from './src/screens/PublishScreen';
import MessagesScreen from './src/screens/MessagesScreen';
import ProfileScreen from './src/screens/ProfileScreen';
import QuestionDetailScreen from './src/screens/QuestionDetailScreen';
import FollowScreen from './src/screens/FollowScreen';
import DebugButton from './src/components/DebugButton';
import HotListScreen from './src/screens/HotListScreen';
import IncomeRankingScreen from './src/screens/IncomeRankingScreen';
import QuestionRankingScreen from './src/screens/QuestionRankingScreen';
import GroupChatScreen from './src/screens/GroupChatScreen';
import AnswerDetailScreen from './src/screens/AnswerDetailScreen';
import SupplementDetailScreen from './src/screens/SupplementDetailScreen';
import ActivityScreen from './src/screens/ActivityScreen';
import LoginScreen from './src/screens/LoginScreen';
import QuestionActivityListScreen from './src/screens/QuestionActivityListScreen';
import MyTeamsScreen from './src/screens/MyTeamsScreen';
import TeamDetailScreen from './src/screens/TeamDetailScreen';
import QuestionTeamsScreen from './src/screens/QuestionTeamsScreen';
import SettingsScreen from './src/screens/SettingsScreen';
import WisdomIndexScreen from './src/screens/WisdomIndexScreen';
import WisdomExamScreen from './src/screens/WisdomExamScreen';
import ExamHistoryScreen from './src/screens/ExamHistoryScreen';
import ExamDetailScreen from './src/screens/ExamDetailScreen';
import QuestionBankScreen from './src/screens/QuestionBankScreen';
import UploadBankScreen from './src/screens/UploadBankScreen';
import ChannelManageScreen from './src/screens/ChannelManageScreen';
import EmergencyScreen from './src/screens/EmergencyScreen';
import CreateActivityScreen from './src/screens/CreateActivityScreen';
import InviteAnswerScreen from './src/screens/InviteAnswerScreen';
import InviteTeamMemberScreen from './src/screens/InviteTeamMemberScreen';
import ReportScreen from './src/screens/ReportScreen';
import AddRewardScreen from './src/screens/AddRewardScreen';
import SuperLikePurchaseScreen from './src/screens/SuperLikePurchaseScreen';
import SuperLikeHistoryScreen from './src/screens/SuperLikeHistoryScreen';
import ContributorsScreen from './src/screens/ContributorsScreen';
import PublicProfileScreen from './src/screens/PublicProfileScreen';
import DeviceInfoScreen from './src/screens/DeviceInfoScreen';
import ChangePasswordScreen from './src/screens/ChangePasswordScreen';
import ConnectionStatusScreen from './src/screens/ConnectionStatusScreen';

const Stack = createNativeStackNavigator();
const Tab = createBottomTabNavigator();

// Emergency Help Modal Component
function EmergencyModal({ visible, onClose, onSubmit }) {
  const t = (key) => {
    if (!i18n || typeof i18n.t !== 'function') {
      return key;
    }
    return i18n.t(key);
  };
  
  const insets = useSafeAreaInsets();
  const [emergencyForm, setEmergencyForm] = useState({ title: '', description: '', location: '', contact: '', rescuerCount: 1 });
  const freeCount = 1;
  const usedCount = 0;
  const remainingFree = freeCount - usedCount;

  const freeRescuerLimit = 5;
  const extraRescuerFee = 2;
  
  const calculateRescuerFee = (count) => {
    if (count <= freeRescuerLimit) return 0;
    return (count - freeRescuerLimit) * extraRescuerFee;
  };

  const rescuerFee = calculateRescuerFee(emergencyForm.rescuerCount || 1);

  // Use useMemo to prevent calling t() during initial render
  const quickTitles = React.useMemo(() => [
    t('emergency.quickTitle1'),
    t('emergency.quickTitle2'),
    t('emergency.quickTitle3')
  ], []);

  const handleSubmit = () => {
    if (!emergencyForm.title.trim()) {
      alert(t('emergency.enterTitle'));
      return;
    }
    const feeInfo = rescuerFee > 0 ? `\n${t('emergency.needPay')}Ôºö$${rescuerFee}` : '';
    alert(`${t('emergency.published')}\n${t('emergency.rescuersNeeded')}${emergencyForm.rescuerCount}${t('emergency.rescuerUnit')}${feeInfo}\n${t('emergency.nearbyNotified')}`);
    onClose();
    setEmergencyForm({ title: '', description: '', location: '', contact: '', rescuerCount: 1 });
  };

  return (
    <Modal visible={visible} animationType="slide">
      <SafeAreaView style={modalStyles.emergencyModal} edges={['top']}>
        <View style={modalStyles.emergencyHeader}>
          <TouchableOpacity onPress={onClose}>
            <Ionicons name="close" size={26} color="#333" />
          </TouchableOpacity>
          <View style={modalStyles.emergencyHeaderCenter}>
            <Ionicons name="alert-circle" size={20} color="#ef4444" />
            <Text style={modalStyles.emergencyHeaderTitle}>{t('emergency.title')}</Text>
          </View>
          <TouchableOpacity 
            style={[modalStyles.emergencySubmitBtn, !emergencyForm.title.trim() && modalStyles.emergencySubmitBtnDisabled]}
            onPress={handleSubmit}
            disabled={!emergencyForm.title.trim()}
          >
            <Text style={[modalStyles.emergencySubmitText, !emergencyForm.title.trim() && modalStyles.emergencySubmitTextDisabled]}>{t('emergency.publish')}</Text>
          </TouchableOpacity>
        </View>

        <View style={modalStyles.emergencyWarning}>
          <Ionicons name="warning" size={18} color="#f59e0b" />
          <Text style={modalStyles.emergencyWarningText}>{t('emergency.warning')}</Text>
        </View>

        <View style={modalStyles.freeCountBanner}>
          <View style={modalStyles.freeCountLeft}>
            <Ionicons name="gift" size={20} color={remainingFree > 0 ? "#22c55e" : "#9ca3af"} />
            <Text style={modalStyles.freeCountText}>{t('emergency.freeCount')}</Text>
            <Text style={[modalStyles.freeCountNumber, remainingFree <= 0 && { color: '#9ca3af' }]}>{remainingFree}/{freeCount}</Text>
          </View>
          {remainingFree <= 0 && (
            <TouchableOpacity 
              style={modalStyles.monthlyPayButton}
              onPress={() => alert(t('emergency.monthlyUnlock'))}
            >
              <Text style={modalStyles.monthlyPayButtonText}>{t('emergency.payAmount')}</Text>
              <Ionicons name="arrow-forward" size={14} color="#fff" />
            </TouchableOpacity>
          )}
        </View>

        <ScrollView style={modalStyles.emergencyFormArea} keyboardShouldPersistTaps="handled">
          <View style={modalStyles.emergencyFormGroup}>
            <Text style={modalStyles.emergencyFormLabel}>{t('emergency.formTitle')} <Text style={{ color: '#ef4444' }}>*</Text></Text>
            <TextInput
              style={modalStyles.emergencyFormInput}
              placeholder={t('emergency.formTitlePlaceholder')}
              placeholderTextColor="#bbb"
              value={emergencyForm.title}
              onChangeText={(text) => setEmergencyForm({...emergencyForm, title: text})}
            />
            <View style={modalStyles.quickTitlesContainer}>
              <Text style={modalStyles.quickTitlesLabel}>{t('emergency.quickTitles')}</Text>
              <View style={modalStyles.quickTitlesRow}>
                {quickTitles.map((title, index) => (
                  <TouchableOpacity
                    key={index}
                    style={modalStyles.quickTitleTag}
                    onPress={() => setEmergencyForm({...emergencyForm, title: title})}
                  >
                    <Text style={modalStyles.quickTitleText}>{title}</Text>
                  </TouchableOpacity>
                ))}
              </View>
            </View>
          </View>

          <View style={modalStyles.emergencyFormGroup}>
            <Text style={modalStyles.emergencyFormLabel}>{t('emergency.description')}</Text>
            <TextInput
              style={[modalStyles.emergencyFormInput, modalStyles.emergencyFormTextarea]}
              placeholder={t('emergency.descriptionPlaceholder')}
              placeholderTextColor="#bbb"
              value={emergencyForm.description}
              onChangeText={(text) => setEmergencyForm({...emergencyForm, description: text})}
              multiline
              textAlignVertical="top"
            />
          </View>

          <View style={modalStyles.emergencyFormGroup}>
            <Text style={modalStyles.emergencyFormLabel}>{t('emergency.location')}</Text>
            <View style={modalStyles.emergencyLocationRow}>
              <View style={modalStyles.emergencyLocationInput}>
                <Ionicons name="location" size={18} color="#ef4444" />
                <TextInput
                  style={modalStyles.emergencyLocationText}
                  placeholder={t('emergency.locationPlaceholder')}
                  placeholderTextColor="#bbb"
                  value={emergencyForm.location}
                  onChangeText={(text) => setEmergencyForm({...emergencyForm, location: text})}
                />
              </View>
              <TouchableOpacity style={modalStyles.emergencyLocationBtn}>
                <Ionicons name="navigate" size={18} color="#3b82f6" />
                <Text style={modalStyles.emergencyLocationBtnText}>{t('emergency.locate')}</Text>
              </TouchableOpacity>
            </View>
          </View>

          <View style={modalStyles.emergencyFormGroup}>
            <Text style={modalStyles.emergencyFormLabel}>{t('emergency.contact')}</Text>
            <View style={modalStyles.emergencyContactInput}>
              <Ionicons name="call" size={18} color="#6b7280" />
              <TextInput
                style={modalStyles.emergencyContactText}
                placeholder={t('emergency.contactPlaceholder')}
                placeholderTextColor="#bbb"
                value={emergencyForm.contact}
                onChangeText={(text) => setEmergencyForm({...emergencyForm, contact: text})}
                keyboardType="phone-pad"
              />
            </View>
          </View>

          <View style={modalStyles.emergencyFormGroup}>
            <View style={modalStyles.rescuerCountHeader}>
              <Text style={modalStyles.emergencyFormLabel}>{t('emergency.rescuerCount')}</Text>
              <View style={modalStyles.rescuerFreeTag}>
                <Ionicons name="information-circle" size={14} color="#22c55e" />
                <Text style={modalStyles.rescuerFreeText}>{t('emergency.rescuerFree')}</Text>
              </View>
            </View>
            
            <View style={modalStyles.rescuerCountInputWrapper}>
              <TextInput
                style={modalStyles.rescuerCountInput}
                placeholder={t('emergency.rescuerPlaceholder')}
                placeholderTextColor="#bbb"
                value={emergencyForm.rescuerCount === 0 ? '' : emergencyForm.rescuerCount.toString()}
                onChangeText={(text) => {
                  if (text === '') {
                    setEmergencyForm({...emergencyForm, rescuerCount: 0});
                    return;
                  }
                  const num = parseInt(text);
                  if (!isNaN(num)) {
                    const validNum = Math.max(1, Math.min(20, num));
                    setEmergencyForm({...emergencyForm, rescuerCount: validNum});
                  }
                }}
                onBlur={() => {
                  if (emergencyForm.rescuerCount === 0) {
                    setEmergencyForm({...emergencyForm, rescuerCount: 1});
                  }
                }}
                keyboardType="number-pad"
                maxLength={2}
              />
              <Text style={modalStyles.rescuerCountUnit}>{t('emergency.rescuerUnit')}</Text>
            </View>

            <View style={modalStyles.rescuerFeeInfo}>
              {rescuerFee === 0 ? (
                <View style={modalStyles.rescuerFeeRow}>
                  <Ionicons name="checkmark-circle" size={16} color="#22c55e" />
                  <Text style={modalStyles.rescuerFeeTextFree}>{t('emergency.rescuerFeeTextFree')}</Text>
                </View>
              ) : (
                <View style={modalStyles.rescuerFeeCard}>
                  <View style={modalStyles.rescuerFeeRow}>
                    <View style={modalStyles.rescuerFeeLeft}>
                      <Text style={modalStyles.rescuerFeeLabel}>{t('emergency.rescuerFeeLabel')}</Text>
                      <Text style={modalStyles.rescuerFeeExtra}>{emergencyForm.rescuerCount - freeRescuerLimit}{t('emergency.rescuerUnit')} √ó ${extraRescuerFee}</Text>
                    </View>
                    <View style={modalStyles.rescuerFeeRight}>
                      <Text style={modalStyles.rescuerFeeTotalLabel}>{t('emergency.needPay')}</Text>
                      <Text style={modalStyles.rescuerFeeTotal}>${rescuerFee}</Text>
                    </View>
                  </View>
                  <Text style={modalStyles.rescuerFeeNote}>{t('emergency.rescuerFeeNote')}</Text>
                  <TouchableOpacity 
                    style={modalStyles.payButton}
                    onPress={() => alert(`${t('emergency.pay')} $${rescuerFee}\n\n${t('emergency.paymentMethods')}`)}
                  >
                    <Ionicons name="card" size={18} color="#fff" />
                    <Text style={modalStyles.payButtonText}>{t('emergency.payNow')} ${rescuerFee}</Text>
                    <Ionicons name="arrow-forward" size={16} color="#fff" />
                  </TouchableOpacity>
                </View>
              )}
            </View>
          </View>

          <View style={modalStyles.emergencyTips}>
            <Text style={modalStyles.emergencyTipsTitle}>{t('emergency.tips')}</Text>
            <Text style={modalStyles.emergencyTipsText}>{t('emergency.tip1')}</Text>
            <Text style={modalStyles.emergencyTipsText}>{t('emergency.tip2')}</Text>
            <Text style={modalStyles.emergencyTipsText}>{t('emergency.tip3')}</Text>
          </View>

          <View style={{ height: insets.bottom + 20 }} />
        </ScrollView>
      </SafeAreaView>
    </Modal>
  );
}

const modalStyles = StyleSheet.create({
  emergencyModal: { flex: 1, backgroundColor: '#fff' },
  emergencyHeader: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 16, paddingVertical: 12, borderBottomWidth: 1, borderBottomColor: '#f0f0f0' },
  emergencyHeaderCenter: { flexDirection: 'row', alignItems: 'center', gap: 6 },
  emergencyHeaderTitle: { fontSize: 17, fontWeight: '600', color: '#222' },
  emergencySubmitBtn: { backgroundColor: '#ef4444', paddingHorizontal: 16, paddingVertical: 8, borderRadius: 4 },
  emergencySubmitBtnDisabled: { backgroundColor: '#fecaca' },
  emergencySubmitText: { fontSize: 14, color: '#fff', fontWeight: '600' },
  emergencySubmitTextDisabled: { color: '#fff' },
  emergencyWarning: { flexDirection: 'row', alignItems: 'center', backgroundColor: '#fffbeb', paddingHorizontal: 16, paddingVertical: 12, gap: 8 },
  emergencyWarningText: { flex: 1, fontSize: 13, color: '#92400e', lineHeight: 18 },
  freeCountBanner: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', backgroundColor: '#f0fdf4', paddingHorizontal: 16, paddingVertical: 12, borderBottomWidth: 1, borderBottomColor: '#e5e7eb' },
  freeCountLeft: { flexDirection: 'row', alignItems: 'center', gap: 6 },
  freeCountText: { fontSize: 14, color: '#374151' },
  freeCountNumber: { fontSize: 16, fontWeight: 'bold', color: '#22c55e' },
  monthlyPayButton: { flexDirection: 'row', alignItems: 'center', gap: 6, backgroundColor: '#ef4444', paddingHorizontal: 14, paddingVertical: 8, borderRadius: 20, shadowColor: '#ef4444', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.3, shadowRadius: 3, elevation: 2 },
  monthlyPayButtonText: { fontSize: 13, color: '#fff', fontWeight: '600' },
  needPayTag: { backgroundColor: '#fef3c7', paddingHorizontal: 10, paddingVertical: 4, borderRadius: 12 },
  needPayText: { fontSize: 12, color: '#92400e', fontWeight: '500' },
  emergencyFormArea: { flex: 1, padding: 16 },
  emergencyFormGroup: { marginBottom: 16 },
  emergencyFormLabel: { fontSize: 14, fontWeight: '500', color: '#374151', marginBottom: 8 },
  emergencyFormInput: { backgroundColor: '#f9fafb', borderWidth: 1, borderColor: '#e5e7eb', borderRadius: 8, paddingHorizontal: 12, paddingVertical: 12, fontSize: 15, color: '#1f2937' },
  quickTitlesContainer: { marginTop: 12 },
  quickTitlesLabel: { fontSize: 12, color: '#6b7280', marginBottom: 8 },
  quickTitlesRow: { flexDirection: 'row', flexWrap: 'wrap', gap: 8 },
  quickTitleTag: { backgroundColor: '#fef2f2', borderWidth: 1, borderColor: '#fecaca', paddingHorizontal: 12, paddingVertical: 6, borderRadius: 16 },
  quickTitleText: { fontSize: 12, color: '#ef4444', fontWeight: '500' },
  emergencyFormTextarea: { minHeight: 100, textAlignVertical: 'top' },
  emergencyLocationRow: { flexDirection: 'row', alignItems: 'center', gap: 10 },
  emergencyLocationInput: { flex: 1, flexDirection: 'row', alignItems: 'center', backgroundColor: '#f9fafb', borderWidth: 1, borderColor: '#e5e7eb', borderRadius: 8, paddingHorizontal: 12, gap: 8 },
  emergencyLocationText: { flex: 1, paddingVertical: 12, fontSize: 15, color: '#1f2937' },
  emergencyLocationBtn: { flexDirection: 'row', alignItems: 'center', backgroundColor: '#eff6ff', paddingHorizontal: 12, paddingVertical: 12, borderRadius: 8, gap: 4 },
  emergencyLocationBtnText: { fontSize: 13, color: '#3b82f6', fontWeight: '500' },
  emergencyContactInput: { flexDirection: 'row', alignItems: 'center', backgroundColor: '#f9fafb', borderWidth: 1, borderColor: '#e5e7eb', borderRadius: 8, paddingHorizontal: 12, gap: 8 },
  emergencyContactText: { flex: 1, paddingVertical: 12, fontSize: 15, color: '#1f2937' },
  rescuerCountHeader: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 },
  rescuerFreeTag: { flexDirection: 'row', alignItems: 'center', gap: 4, backgroundColor: '#f0fdf4', paddingHorizontal: 10, paddingVertical: 4, borderRadius: 12, borderWidth: 1, borderColor: '#bbf7d0' },
  rescuerFreeText: { fontSize: 12, color: '#16a34a', fontWeight: '500' },
  rescuerCountInputWrapper: { flexDirection: 'row', alignItems: 'center', backgroundColor: '#f9fafb', borderWidth: 1, borderColor: '#e5e7eb', borderRadius: 8, paddingHorizontal: 12, gap: 8 },
  rescuerCountInput: { flex: 1, paddingVertical: 12, fontSize: 15, color: '#1f2937' },
  rescuerCountUnit: { fontSize: 15, color: '#6b7280', fontWeight: '500' },
  rescuerFeeInfo: { marginTop: 12 },
  rescuerFeeRow: { flexDirection: 'row', alignItems: 'center', gap: 6 },
  rescuerFeeTextFree: { fontSize: 14, color: '#22c55e', fontWeight: '500' },
  rescuerFeeCard: { backgroundColor: '#fff7ed', borderWidth: 1, borderColor: '#fed7aa', borderRadius: 8, padding: 12 },
  rescuerFeeLeft: { flex: 1 },
  rescuerFeeLabel: { fontSize: 13, color: '#92400e', marginBottom: 4 },
  rescuerFeeExtra: { fontSize: 15, color: '#ea580c', fontWeight: '600' },
  rescuerFeeRight: { alignItems: 'flex-end' },
  rescuerFeeTotalLabel: { fontSize: 12, color: '#92400e', marginBottom: 2 },
  rescuerFeeTotal: { fontSize: 24, fontWeight: 'bold', color: '#ef4444' },
  rescuerFeeNote: { fontSize: 12, color: '#92400e', marginTop: 8 },
  payButton: { flexDirection: 'row', alignItems: 'center', justifyContent: 'center', backgroundColor: '#ef4444', paddingVertical: 12, paddingHorizontal: 16, borderRadius: 8, marginTop: 12, gap: 8, shadowColor: '#ef4444', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.3, shadowRadius: 4, elevation: 3 },
  payButtonText: { fontSize: 15, color: '#fff', fontWeight: '600' },
  emergencyTips: { backgroundColor: '#fef2f2', borderRadius: 8, padding: 12, marginTop: 8 },
  emergencyTipsTitle: { fontSize: 13, fontWeight: '500', color: '#991b1b', marginBottom: 8 },
  emergencyTipsText: { fontSize: 12, color: '#b91c1c', lineHeight: 20 },
});

function MainTabs({ onLogout }) {
  const insets = useSafeAreaInsets();
  
  // ÂÆö‰πâÂõ∫ÂÆöÁöÑ tab ÂêçÁß∞Ôºà‰ΩøÁî®Ëã±Êñá keyÔºâ
  const TAB_NAMES = {
    HOME: 'Home',
    ACTIVITY: 'Activity',
    PUBLISH: 'Publish',
    EMERGENCY: 'Emergency',
    PROFILE: 'Profile'
  };
  
  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color }) => {
          let iconName;
          if (route.name === TAB_NAMES.HOME) iconName = focused ? 'home' : 'home-outline';
          else if (route.name === TAB_NAMES.ACTIVITY) iconName = focused ? 'gift' : 'gift-outline';
          else if (route.name === TAB_NAMES.PUBLISH) iconName = focused ? 'add-circle' : 'add-circle-outline';
          else if (route.name === TAB_NAMES.EMERGENCY) iconName = focused ? 'warning' : 'warning-outline';
          else if (route.name === TAB_NAMES.PROFILE) iconName = focused ? 'person' : 'person-outline';
          return <Ionicons name={iconName} size={24} color={color} />;
        },
        tabBarLabel: ({ focused }) => {
          let labelKey;
          if (route.name === TAB_NAMES.HOME) labelKey = 'tabs.home';
          else if (route.name === TAB_NAMES.ACTIVITY) labelKey = 'tabs.activity';
          else if (route.name === TAB_NAMES.PUBLISH) labelKey = 'tabs.publish';
          else if (route.name === TAB_NAMES.EMERGENCY) labelKey = 'tabs.emergency';
          else if (route.name === TAB_NAMES.PROFILE) labelKey = 'tabs.profile';
          
          // Áõ¥Êé•‰ΩøÁî® i18n.tÔºåÂπ∂Ê∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•
          const labelText = i18n && i18n.t ? i18n.t(labelKey) : labelKey;
          return <Text style={{ fontSize: 10, fontWeight: '400', color: focused ? '#f04444' : '#8a8a8a' }}>{labelText}</Text>;
        },
        tabBarActiveTintColor: '#f04444',
        tabBarInactiveTintColor: '#8a8a8a',
        tabBarIconStyle: {
          marginBottom: 2,
        },
        tabBarStyle: {
          backgroundColor: '#ffffff',
          height: 60 + insets.bottom,
          paddingBottom: insets.bottom > 0 ? insets.bottom : 8,
          paddingTop: 8,
          borderTopWidth: StyleSheet.hairlineWidth,
          borderTopColor: '#e8e8e8',
          elevation: 0,
          shadowOpacity: 0,
        },
        headerShown: false,
      })}
    >
      <Tab.Screen name={TAB_NAMES.HOME} component={HomeScreen} />
      <Tab.Screen name={TAB_NAMES.ACTIVITY} component={ActivityScreen} />
      <Tab.Screen name={TAB_NAMES.PUBLISH} component={PublishScreen} />
      <Tab.Screen name={TAB_NAMES.EMERGENCY} component={EmergencyScreen} />
      <Tab.Screen name={TAB_NAMES.PROFILE}>
        {(props) => <ProfileScreen {...props} onLogout={onLogout} />}
      </Tab.Screen>
    </Tab.Navigator>
  );
}

export default function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [isInitializing, setIsInitializing] = useState(true);
  const [fontsLoaded, setFontsLoaded] = useState(false);
  const toastRef = React.useRef(null);

  // ËÆæÁΩÆ Toast ÂºïÁî®
  useEffect(() => {
    if (toastRef.current) {
      setToastRef(toastRef.current);
    }
  }, []);

  // È¢ÑÂä†ËΩΩÂ≠ó‰Ωì
  useEffect(() => {
    async function loadFonts() {
      try {
        await Font.loadAsync({
          ...Ionicons.font,
        });
        setFontsLoaded(true);
      } catch (error) {
        console.error('Error loading fonts:', error);
        // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•‰πüÁªßÁª≠ÔºåÈÅøÂÖçÂç°‰Ωè
        setFontsLoaded(true);
      }
    }
    loadFonts();
  }, []);

  // ÂàùÂßãÂåñÊúçÂä°ÂíåÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
  useEffect(() => {
    // Ëá™Âä®Ê≥®ÂÜåÈáçËØïÂáΩÊï∞ÔºàÂºÄÂèëÂíåÁîü‰∫ßÁéØÂ¢ÉÈÉΩ‰ΩøÁî®Ôºâ
    const autoRegisterWithRetry = async (fingerprint, maxRetries = 3) => {
      for (let i = 0; i < maxRetries; i++) {
        try {
          console.log(`üîÑ Â∞ùËØïËá™Âä®Ê≥®ÂÜå (${i + 1}/${maxRetries})...`);
          const response = await authApi.registerByFingerprint(fingerprint);
          
          if (response.code === 200 && response.data) {
            console.log('‚úÖ Ëá™Âä®Ê≥®ÂÜåÊàêÂäüÔºÅ');
            return { success: true, data: response.data };
          } else {
            console.error(`‚ö†Ô∏è Á¨¨ ${i + 1} Ê¨°Â∞ùËØïËøîÂõûÈîôËØØ:`, response.msg);
          }
        } catch (error) {
          console.error(`‚ùå Á¨¨ ${i + 1} Ê¨°Â∞ùËØïÂ§±Ë¥•:`, error.message);
          
          if (i < maxRetries - 1) {
            // ÊåáÊï∞ÈÄÄÈÅøÔºö1s, 2s, 4s
            const delay = Math.pow(2, i) * 1000;
            console.log(`‚è≥ Á≠âÂæÖ ${delay}ms ÂêéÈáçËØï...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      return { success: false };
    };

    const initializeApp = async () => {
      try {
        console.log('üöÄ Â∫îÁî®ÂêØÂä®‰∏≠...');
        console.log('‚öôÔ∏è  ÁéØÂ¢É:', __DEV__ ? 'ÂºÄÂèëÁéØÂ¢É' : 'Áîü‰∫ßÁéØÂ¢É');
        console.log('');
        
        // ÂàùÂßãÂåñË∂ÖÁ∫ßËµûÁßØÂàÜÁ≥ªÁªüÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°ûÔºâ
        superLikeCreditService.initialize().catch(error => {
          console.error('‚ö†Ô∏è Service initialization failed:', error);
        });
        
        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑ tokenÔºàËá™Âä®ÁôªÂΩïÔºâ
        const savedToken = await AsyncStorage.getItem('authToken');
        
        if (savedToken) {
          console.log('‚úÖ Ê£ÄÊµãÂà∞Â∑≤‰øùÂ≠òÁöÑ tokenÔºåËá™Âä®ÁôªÂΩï');
          console.log('   Token (Ââç20Â≠óÁ¨¶):', savedToken.substring(0, 20) + '...');
          
          // Ë∞ÉËØïÔºöÊ£ÄÊü• token Áä∂ÊÄÅÔºà‰ªÖÂºÄÂèëÁéØÂ¢ÉÔºâ
          if (__DEV__) {
            DebugToken.checkTokenStatus().catch(e => console.error('Debug check failed:', e));
            DebugToken.testTokenInRequest().catch(e => console.error('Debug test failed:', e));
          }
          
          // Á´ãÂç≥ËÆæÁΩÆÁôªÂΩïÁä∂ÊÄÅÔºåËÆ©Áî®Êà∑ËøõÂÖ•Â∫îÁî®
          setIsLoggedIn(true);
          setIsInitializing(false);
          
          // ÂêéÂè∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÔºà‰∏çÈòªÂ°ûUIÔºâ
          console.log('\nüë§ ÂêéÂè∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ...');
          UserCacheService.loadUserProfileWithCache(
            (cachedProfile) => {
              console.log('‚ö° ‰ªéÁºìÂ≠òÂä†ËΩΩÁî®Êà∑‰ø°ÊÅØ:', cachedProfile?.nickName || 'Unknown');
            },
            (freshProfile) => {
              console.log('üîÑ Áî®Êà∑‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞:', freshProfile?.nickName || 'Unknown');
            }
          ).catch(async (userError) => {
            console.error('‚ö†Ô∏è User profile loading failed:', userError);
            // Â¶ÇÊûúÊòØÁôªÂΩïÁä∂ÊÄÅËøáÊúüÊàñ 401 ÈîôËØØÔºåÂ∞ùËØïÈáçÊñ∞Ê≥®ÂÜå
            const errorMsg = userError.message || '';
            if (errorMsg.includes('ÁôªÂΩïÁä∂ÊÄÅÂ∑≤ËøáÊúü') || errorMsg.includes('Êú™ÊéàÊùÉ') || userError.status === 401) {
              console.log('üö™ Ê£ÄÊµãÂà∞ÁôªÂΩïÁä∂ÊÄÅËøáÊúüÔºåÂ∞ùËØïÈáçÊñ∞Ê≥®ÂÜå...');
              
              // Ê∏ÖÈô§ËøáÊúüÊï∞ÊçÆ
              await AsyncStorage.multiRemove(['authToken', 'refreshToken', 'userInfo']);
              
              // Â∞ùËØï‰ΩøÁî®ËÆæÂ§áÊåáÁ∫πÈáçÊñ∞Ê≥®ÂÜåÔºàÂºÄÂèëÂíåÁîü‰∫ßÁéØÂ¢ÉÈÉΩÊâßË°åÔºâ
              const savedFingerprint = await AsyncStorage.getItem('deviceFingerprint');
              
              if (savedFingerprint) {
                console.log('üîÑ ‰ΩøÁî®Â∑≤‰øùÂ≠òÁöÑËÆæÂ§áÊåáÁ∫πÈáçÊñ∞Ê≥®ÂÜå...');
                const result = await autoRegisterWithRetry(savedFingerprint);
                
                if (result.success) {
                  console.log('‚úÖ Ëá™Âä®ÈáçÊñ∞Ê≥®ÂÜåÊàêÂäüÔºÅ');
                  setIsLoggedIn(true);
                  showToast('ÁôªÂΩïÂ∑≤Êõ¥Êñ∞', 'success');
                } else {
                  console.error('‚ùå Ëá™Âä®ÈáçÊñ∞Ê≥®ÂÜåÂ§±Ë¥•');
                  setIsLoggedIn(false);
                  showToast('ÁôªÂΩïÁä∂ÊÄÅÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                }
              } else {
                // Ê≤°ÊúâËÆæÂ§áÊåáÁ∫πÔºåÈÄÄÂá∫ÁôªÂΩï
                setIsLoggedIn(false);
                showToast('ÁôªÂΩïÁä∂ÊÄÅÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
              }
            }
          });
        } else {
          console.log('üì± Êú™Ê£ÄÊµãÂà∞ tokenÔºåÊ£ÄÊü•ËÆæÂ§áÊåáÁ∫π...');
          
          // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑËÆæÂ§áÊåáÁ∫π
          const savedFingerprint = await AsyncStorage.getItem('deviceFingerprint');
          
          if (savedFingerprint) {
            console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞ËÆæÂ§áÊåáÁ∫π‰ΩÜÊó† tokenÔºåÂèØËÉΩÊòØÁî®Êà∑ÈÄÄÂá∫ÁôªÂΩï');
            console.log('   ÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢');
            setIsInitializing(false);
            // Áî®Êà∑Â∑≤ÁªèÊ≥®ÂÜåËøá‰ΩÜÈÄÄÂá∫‰∫ÜÔºåÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
          } else {
            console.log('üÜï È¶ñÊ¨°‰ΩøÁî®ÔºåÂºÄÂßãËÆæÂ§áÊåáÁ∫πËá™Âä®Ê≥®ÂÜå...');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            try {
              // ÁîüÊàêËÆæÂ§áÊåáÁ∫πÂ≠óÁ¨¶‰∏≤
              console.log('üì± Ê≠•È™§ 1: ÁîüÊàêËÆæÂ§áÊåáÁ∫π');
              const fingerprint = await DeviceInfo.generateFingerprintString();
              console.log('   ‚úÖ ËÆæÂ§áÊåáÁ∫πÁîüÊàêÊàêÂäü:', fingerprint);
              
              // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂Ë∞ÉÁî®Ëá™Âä®Ê≥®ÂÜåÊé•Âè£
              console.log('\nüì° Ê≠•È™§ 2: Ë∞ÉÁî®Ëá™Âä®Ê≥®ÂÜåÊé•Âè£ÔºàÂ∏¶ÈáçËØïÔºâ');
              const result = await autoRegisterWithRetry(fingerprint);
              
              console.log('\nüìä Ê≠•È™§ 3: Â§ÑÁêÜÊ≥®ÂÜåÁªìÊûú');
              
              if (result.success && result.data) {
                console.log('\n‚úÖ Ëá™Âä®Ê≥®ÂÜåÊàêÂäüÔºÅ');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üë§ Áî®Êà∑‰ø°ÊÅØ:');
                console.log('   Áî®Êà∑Âêç:', result.data.userBaseInfo?.username);
                console.log('   Áî®Êà∑ID:', result.data.userBaseInfo?.userId);
                console.log('   ÈªòËÆ§ÂØÜÁ†Å: 12345678');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // Ëá™Âä®ÁôªÂΩïËøõÂÖ•Â∫îÁî®
                setIsLoggedIn(true);
                setIsInitializing(false);
                
                // ÊòæÁ§∫Ê¨¢ËøéÊèêÁ§∫
                setTimeout(() => {
                  showToast(`Ê¨¢Ëøé‰ΩøÁî®ÔºÅÊÇ®ÁöÑÁî®Êà∑ÂêçÊòØ ${result.data.userBaseInfo?.username}ÔºåÈªòËÆ§ÂØÜÁ†ÅÊòØ 12345678`, 'success');
                }, 1000);
              } else {
                console.error('\n‚ùå Ëá™Âä®Ê≥®ÂÜåÂ§±Ë¥•ÔºàÂ∑≤ÈáçËØï3Ê¨°Ôºâ');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                setIsInitializing(false);
                
                // Ëá™Âä®Ê≥®ÂÜåÂ§±Ë¥•ÔºåÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢ÔºåÁî®Êà∑ÂèØ‰ª•ÊâãÂä®ÈáçËØï
                setTimeout(() => {
                  showToast('È¶ñÊ¨°ÂêØÂä®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑ÁÇπÂáª"‰ΩøÁî®ËÆæÂ§áÁôªÂΩï"ÈáçËØï', 'error');
                }, 500);
              }
            } catch (registerError) {
              console.error('\n‚ùå Ëá™Âä®Ê≥®ÂÜåÂºÇÂ∏∏');
              console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              console.error('ÈîôËØØÁ±ªÂûã:', registerError.constructor.name);
              console.error('ÈîôËØØÊ∂àÊÅØ:', registerError.message);
              console.error('ÈîôËØØÂ†ÜÊ†à:', registerError.stack);
              console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              
              setIsInitializing(false);
              
              // ÁΩëÁªúÈîôËØØÊàñÂÖ∂‰ªñÂºÇÂ∏∏ÔºåÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
              setTimeout(() => {
                showToast('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÁÇπÂáª"‰ΩøÁî®ËÆæÂ§áÁôªÂΩï"', 'error');
              }, 500);
            }
          }
        }
      } catch (error) {
        console.error('‚ùå Failed to initialize app:', error);
        console.error('Error stack:', error.stack);
        setIsInitializing(false);
      }
    };

    initializeApp();
  }, []);

  // ÁõëÂê¨ Token ÂèòÂåñÔºåÂΩì Token Ë¢´Ê∏ÖÈô§Êó∂Ëá™Âä®ÈÄÄÂá∫ÁôªÂΩï
  useEffect(() => {
    if (!isLoggedIn) return;

    const checkTokenInterval = setInterval(async () => {
      const token = await AsyncStorage.getItem('authToken');
      if (!token && isLoggedIn) {
        console.log('üö™ Ê£ÄÊµãÂà∞ Token Ë¢´Ê∏ÖÈô§ÔºåËá™Âä®ÈÄÄÂá∫ÁôªÂΩï');
        setIsLoggedIn(false);
      }
    }, 1000); // ÊØèÁßíÊ£ÄÊü•‰∏ÄÊ¨°

    return () => clearInterval(checkTokenInterval);
  }, [isLoggedIn]);

  // ÊòæÁ§∫Âä†ËΩΩÁïåÈù¢Áõ¥Âà∞Â≠ó‰ΩìÂíåÂàùÂßãÂåñÂÆåÊàê
  if (!fontsLoaded || isInitializing) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#fff' }}>
        <ActivityIndicator size="large" color="#ef4444" />
        <Text style={{ marginTop: 16, fontSize: 14, color: '#6b7280' }}>
          {!fontsLoaded ? 'Âä†ËΩΩ‰∏≠...' : 'Ê≠£Âú®ÂàùÂßãÂåñ...'}
        </Text>
      </View>
    );
  }

  const handleLogin = () => {
    setIsLoggedIn(true);
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
  };

  if (!isLoggedIn) {
    return (
      <SafeAreaProvider>
        <StatusBar style="dark" />
        <LoginScreen onLogin={handleLogin} />
        <ToastContainer ref={toastRef} />
      </SafeAreaProvider>
    );
  }

  return (
    <SafeAreaProvider>
      <NavigationContainer>
        <StatusBar style="dark" />
        <Stack.Navigator screenOptions={{ headerShown: false }}>
            <Stack.Screen name="Main">
              {() => <MainTabs onLogout={handleLogout} />}
            </Stack.Screen>
          <Stack.Screen name="Search" component={SearchScreen} />
          <Stack.Screen name="QuestionDetail" component={QuestionDetailScreen} />
          <Stack.Screen name="SupplementDetail" component={SupplementDetailScreen} />
          <Stack.Screen name="QuestionActivityList" component={QuestionActivityListScreen} />
        <Stack.Screen name="Follow" component={FollowScreen} />
        <Stack.Screen name="HotList" component={HotListScreen} />
        <Stack.Screen name="IncomeRanking" component={IncomeRankingScreen} />
        <Stack.Screen name="QuestionRanking" component={QuestionRankingScreen} />
        <Stack.Screen name="Messages" component={MessagesScreen} />
        <Stack.Screen name="GroupChat" component={GroupChatScreen} />
        <Stack.Screen name="AnswerDetail" component={AnswerDetailScreen} />
        <Stack.Screen name="MyTeams" component={MyTeamsScreen} />
        <Stack.Screen name="QuestionTeams" component={QuestionTeamsScreen} />
        <Stack.Screen name="TeamDetail" component={TeamDetailScreen} />
        <Stack.Screen name="Settings" component={SettingsScreen} />
        <Stack.Screen name="ChannelManage" component={ChannelManageScreen} />
        <Stack.Screen name="WisdomIndex" component={WisdomIndexScreen} />
        <Stack.Screen name="WisdomExam" component={WisdomExamScreen} />
        <Stack.Screen name="ExamHistory" component={ExamHistoryScreen} />
        <Stack.Screen name="ExamDetail" component={ExamDetailScreen} />
        <Stack.Screen name="QuestionBank" component={QuestionBankScreen} />
        <Stack.Screen name="UploadBank" component={UploadBankScreen} />
        <Stack.Screen name="CreateActivity" component={CreateActivityScreen} />
        <Stack.Screen name="InviteAnswer" component={InviteAnswerScreen} />
        <Stack.Screen name="InviteTeamMember" component={InviteTeamMemberScreen} />
        <Stack.Screen name="Report" component={ReportScreen} />
        <Stack.Screen name="AddReward" component={AddRewardScreen} />
        <Stack.Screen name="SuperLikePurchase" component={SuperLikePurchaseScreen} />
        <Stack.Screen name="SuperLikeHistory" component={SuperLikeHistoryScreen} />
        <Stack.Screen name="Contributors" component={ContributorsScreen} />
        <Stack.Screen name="PublicProfile" component={PublicProfileScreen} />
        <Stack.Screen name="DeviceInfo" component={DeviceInfoScreen} />
        <Stack.Screen name="ChangePassword" component={ChangePasswordScreen} />
        <Stack.Screen name="ConnectionStatus" component={ConnectionStatusScreen} />
        </Stack.Navigator>
        
        {/* Ë∞ÉËØïÊåâÈíÆ - ‰ªÖÂºÄÂèëÁéØÂ¢ÉÊòæÁ§∫ */}
        <DebugButton />
        <ToastContainer ref={toastRef} />
      </NavigationContainer>
    </SafeAreaProvider>
  );
}
