# 实施计划：超级赞积分系统

## 概述

本实施计划将当前绑定特定回答的超级赞购买模式重构为基于积分的通用系统。实施分为核心服务、UI组件、数据迁移和集成四个主要阶段。

## 任务

- [ ] 1. 创建核心服务和数据模型
  - [x] 1.1 创建 SuperLikeCreditService 服务类
    - 实现 getBalance()、purchase()、use()、getHistory()、initialize() 方法
    - 实现 AsyncStorage 数据持久化
    - 实现错误处理和数据验证
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 5.1, 5.2, 5.3, 6.1, 6.2, 6.3, 6.4_
  
  - [x]* 1.2 为 SuperLikeCreditService 编写属性测试
    - **属性 2: 购买增加余额**
    - **验证需求: 1.4**
  
  - [x]* 1.3 为 SuperLikeCreditService 编写属性测试
    - **属性 3: 使用减少余额**
    - **验证需求: 2.4**
  
  - [x]* 1.4 为 SuperLikeCreditService 编写属性测试
    - **属性 8: 数据持久化往返**
    - **验证需求: 6.1, 6.2, 6.3, 6.4**
  
  - [x]* 1.5 为 SuperLikeCreditService 编写单元测试
    - 测试边界情况：余额为0、无效购买数量
    - 测试错误处理：存储失败、数据损坏
    - _需求: 2.3, 6.5_

- [ ] 2. 创建购买页面组件
  - [x] 2.1 创建 SuperLikePurchaseScreen 组件
    - 实现余额显示
    - 实现快速选择购买数量（5, 10, 20, 50, 100）
    - 实现自定义输入数量
    - 实现价格计算和显示
    - 实现购买确认和成功提示
    - 集成 SuperLikeCreditService
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 3.2, 4.4_
  
  - [ ]* 2.2 为购买页面编写属性测试
    - **属性 1: 价格计算正确性**
    - **验证需求: 1.3**
  
  - [ ]* 2.3 为购买页面编写单元测试
    - 测试 UI 渲染
    - 测试用户交互（选择数量、输入数量、确认购买）
    - 测试错误提示
    - _需求: 1.2, 1.3_

- [ ] 3. 创建可复用组件
  - [x] 3.1 创建 SuperLikeBalance 余额显示组件
    - 实现不同尺寸（small, medium, large）
    - 实现可选标签显示
    - 实现点击跳转购买页面
    - 实现实时余额更新
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 3.2 创建 UseSuperLikeButton 使用按钮组件
    - 实现余额检查
    - 实现使用确认对话框
    - 实现成功提示
    - 实现余额不足提示和购买引导
    - 集成 SuperLikeCreditService
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 4.2_
  
  - [ ]* 3.3 为使用按钮编写属性测试
    - **属性 4: 回答超级赞计数增加**
    - **验证需求: 2.5**
  
  - [ ]* 3.4 为使用按钮编写属性测试
    - **属性 5: 余额为零时禁止使用**
    - **验证需求: 2.2, 2.3**
  
  - [ ]* 3.5 为可复用组件编写单元测试
    - 测试 SuperLikeBalance 的不同尺寸和状态
    - 测试 UseSuperLikeButton 的不同状态（余额充足/不足）
    - _需求: 3.1, 3.3, 3.4_

- [ ] 4. 创建交易历史页面
  - [x] 4.1 创建 SuperLikeHistoryScreen 组件
    - 实现交易记录列表显示
    - 实现交易类型区分（购买/使用）
    - 实现交易详情显示（数量、时间、相关回答）
    - 实现空状态显示
    - 集成 SuperLikeCreditService
    - _需求: 5.3, 5.4, 5.5_
  
  - [ ]* 4.2 为交易历史编写属性测试
    - **属性 6: 交易记录完整性**
    - **验证需求: 1.5, 2.6**
  
  - [ ]* 4.3 为交易历史编写属性测试
    - **属性 7: 交易历史排序**
    - **验证需求: 5.5**
  
  - [ ]* 4.4 为交易历史编写单元测试
    - 测试记录显示
    - 测试排序
    - 测试空状态
    - _需求: 5.3, 5.4, 5.5_

- [ ]* 5. 检查点 - 确保所有核心功能测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 添加国际化支持
  - [x] 6.1 在 zh.json 中添加超级赞相关的中文翻译
    - 添加购买页面文本
    - 添加使用按钮文本
    - 添加交易历史文本
    - 添加错误提示文本
    - _需求: 7.1, 7.2, 7.3, 7.4_
  
  - [x] 6.2 在 en.json 中添加超级赞相关的英文翻译
    - 添加购买页面文本
    - 添加使用按钮文本
    - 添加交易历史文本
    - 添加错误提示文本
    - _需求: 7.1, 7.2, 7.3, 7.4_
  
  - [x] 6.3 更新所有组件使用 i18n 翻译
    - 更新 SuperLikePurchaseScreen
    - 更新 SuperLikeHistoryScreen
    - 更新 SuperLikeBalance
    - 更新 UseSuperLikeButton
    - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 7. 实现数据迁移
  - [x] 7.1 在 SuperLikeCreditService 中实现 migrateOldData() 方法
    - 检查迁移标志
    - 保留现有回答的超级赞计数
    - 初始化用户余额为 0
    - 设置迁移标志
    - _需求: 8.1, 8.2_
  
  - [x] 7.2 在 App.js 中调用数据迁移
    - 在应用启动时调用 SuperLikeCreditService.initialize()
    - 处理迁移错误
    - _需求: 8.1, 8.2_
  
  - [ ]* 7.3 为数据迁移编写单元测试
    - 测试迁移逻辑
    - 测试迁移标志
    - 测试数据保留
    - _需求: 8.1, 8.2_

- [ ] 8. 更新现有页面集成新功能
  - [ ] 8.1 更新 QuestionDetailScreen（回答列表页面）
    - 移除旧的购买按钮（导航到 BuySuperLike）
    - 添加 UseSuperLikeButton 组件
    - 添加 SuperLikeBalance 组件显示当前余额
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.3, 8.4_
  
  - [ ] 8.2 更新 AnswerDetailScreen（回答详情页面）
    - 移除旧的购买按钮（导航到 BuySuperLike）
    - 添加 UseSuperLikeButton 组件
    - 添加 SuperLikeBalance 组件显示当前余额
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.3, 8.4_
  
  - [x] 8.3 更新 ProfileScreen（个人中心）
    - 添加 SuperLikeBalance 组件显示余额
    - 添加购买超级赞入口按钮
    - 添加交易历史入口按钮
    - _需求: 3.1, 4.1, 4.3_
  
  - [x] 8.4 更新 SettingsScreen（设置页面）
    - 添加购买超级赞入口
    - _需求: 4.3_

- [ ] 9. 更新导航配置
  - [x] 9.1 在 App.js 中更新路由配置
    - 移除 BuySuperLike 路由
    - 添加 SuperLikePurchase 路由
    - 添加 SuperLikeHistory 路由
    - _需求: 4.4, 8.3, 8.5_
  
  - [x] 9.2 删除旧的 BuySuperLikeScreen.js 文件
    - 删除 src/screens/BuySuperLikeScreen.js
    - _需求: 8.3_

- [ ]* 10. 检查点 - 确保所有集成测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ]* 11. 编写集成测试
  - [ ]* 11.1 编写完整购买流程测试
    - 测试从打开购买页面到购买成功的完整流程
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [ ]* 11.2 编写完整使用流程测试
    - 测试从打开回答页面到使用超级赞的完整流程
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  
  - [ ]* 11.3 编写余额不足流程测试
    - 测试余额为0时尝试使用的完整流程
    - _需求: 2.3, 4.2_
  
  - [ ]* 11.4 编写交易历史流程测试
    - 测试执行多次购买和使用后查看历史的完整流程
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 11.5 编写属性测试验证数据一致性
    - **属性 9: 余额和交易历史的一致性**
    - **验证需求: 1.4, 2.4**

- [ ]* 12. 最终检查点 - 确保所有功能正常工作
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 每个任务都引用了相关的需求编号，便于追溯
- 检查点任务确保增量验证
- 标记为 `[ ]*` 的任务为可选任务（主要是测试相关）
- 核心功能任务为必需任务，专注于实现业务逻辑
- 属性测试使用 fast-check 库，每个测试至少运行 100 次迭代
- 单元测试使用 Jest 框架
